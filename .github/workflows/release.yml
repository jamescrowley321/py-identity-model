name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
        type: string

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install dependencies
        run: make ci-setup

      - name: Lint
        run: make lint

      - name: Unit Tests
        run: make test-unit

      - name: Integration Tests (ORY)
        run: make test-integration-ory
        env:
          TEST_DISCO_ADDRESS: ${{ secrets.TEST_DISCO_ADDRESS }}
          TEST_JWKS_ADDRESS: ${{ secrets.TEST_JWKS_ADDRESS }}
          TEST_CLIENT_ID: ${{ secrets.TEST_CLIENT_ID }}
          TEST_CLIENT_SECRET: ${{ secrets.TEST_CLIENT_SECRET }}
          TEST_SCOPE: ${{ secrets.TEST_SCOPE }}
          TEST_EXPIRED_TOKEN: ${{ secrets.TEST_EXPIRED_TOKEN }}
          TEST_AUDIENCE: ${{ secrets.TEST_AUDIENCE }}

      - name: Determine branch name
        id: branch
        run: |
          BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          if [[ "$BRANCH" == "main" ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Semantic Version Release
        id: release
        uses: python-semantic-release/python-semantic-release@v10.0.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions"
          git_committer_email: "actions@users.noreply.github.com"

      - name: Build distribution
        if: steps.release.outputs.released == 'true'
        run: |
          echo "Building version ${{ steps.release.outputs.version }}"
          # Ensure version is set in pyproject.toml (semantic-release should have done this,
          # but we verify/set it explicitly to be safe)
          sed -i -e "s/0.0.0/${{ steps.release.outputs.version }}/" pyproject.toml
          make build-dist

      - name: Upload to GitHub Release Assets
        uses: python-semantic-release/publish-action@v10.0.2
        if: steps.release.outputs.released == 'true'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.release.outputs.tag }}

      - name: Publish to PyPI
        if: steps.release.outputs.released == 'true'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.pypi_token }}
        run: make upload-dist

      - name: Release Summary
        if: steps.release.outputs.released == 'true'
        run: |
          echo "## Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.branch.outputs.is_prerelease }}" == "true" ]]; then
            echo "This is a **prerelease** version." >> $GITHUB_STEP_SUMMARY
          else
            echo "This is a **stable** release." >> $GITHUB_STEP_SUMMARY
          fi

      - name: No Release Needed
        if: steps.release.outputs.released != 'true'
        run: |
          echo "## No Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No release was created. This can happen if:" >> $GITHUB_STEP_SUMMARY
          echo "- There are no releasable commits (commits must follow conventional commit format)" >> $GITHUB_STEP_SUMMARY
          echo "- The version would not change based on the commits" >> $GITHUB_STEP_SUMMARY
