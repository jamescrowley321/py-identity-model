name: Publish Pre-release to GitHub üöÄ

on:
  push:
    tags:
      # Match pre-release tags: 2.0.0-rc.1, 2.0.0-alpha.1, 2.0.0-beta.1
      - "[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+"

permissions:
  contents: write

jobs:
  publish-prerelease:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install dependencies
        run: make ci-setup

      - name: Set tag version
        id: vars
        run: echo "tag=$(git describe --tags $(git rev-list --tags --max-count=1))" >> $GITHUB_OUTPUT

      - name: Display version
        run: echo "Publishing version ${{ steps.vars.outputs.tag }} to GitHub Releases"

      - name: Build distribution üì¶
        run: |
          echo ${{ steps.vars.outputs.tag }}
          sed -i -e "s/0.0.0/${{ steps.vars.outputs.tag }}/" pyproject.toml
          make build-dist

      - name: Get wheel filename
        id: wheel
        run: echo "filename=$(ls dist/*.whl | xargs -n 1 basename)" >> $GITHUB_OUTPUT

      - name: Create GitHub Pre-release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          files: dist/*
          body: |
            ## Pre-release ${{ steps.vars.outputs.tag }}

            This is a pre-release version for testing purposes.

            ### Installation for Testing

            **Option 1: Install from GitHub Release (Recommended)**
            ```bash
            # Using pip
            pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.tag }}/${{ steps.wheel.outputs.filename }}

            # Using uv
            uv pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.tag }}/${{ steps.wheel.outputs.filename }}
            ```

            **Option 2: Install from Git Tag**
            ```bash
            # Using pip
            pip install git+https://github.com/${{ github.repository }}.git@${{ steps.vars.outputs.tag }}

            # Using uv
            uv pip install git+https://github.com/${{ github.repository }}.git@${{ steps.vars.outputs.tag }}
            ```

            **Option 3: Install in editable mode for development**
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd py-identity-model
            git checkout ${{ steps.vars.outputs.tag }}
            pip install -e .
            ```

            ---

            ‚ö†Ô∏è **This is a pre-release version.** Do not use in production.

            For production use, install the stable version from PyPI:
            ```bash
            pip install py-identity-model
            ```
